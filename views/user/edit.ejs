<%- partial('../_alert.ejs', {flash: flash}) %>

<form id="sign-up-form" class="form-signin" action="/user/update/<%= user.id %>" method="post" enctype="multipart/form-data" data-parsley-validate style="max-width: none">
  <div class="row">
    <h1 class="text-center login-title marginbottom20"><%= i18n('editaccount') %></h1>

    <div class="col-md-6">
      <div class="col-md-2"></div>
      <div class="col-md-10">
        <div class="control-group">
          <label for="name"><%= i18n("name") %> * :</label>
          <input class="form-control" name="name" placeholder="<%= i18n("name") %>" value="<%= user.name %>" required="" type="text">
        </div>

        <div class="control-group">
          <label for="email"><%= i18n("email") %> * :</label>
          <input class="form-control" name="email" placeholder="<%= i18n("email") %>" value="<%= user.email %>" data-parsley-trigger="change" required="" type="email">
        </div>


        <div class=" margintop10">
          <label for="question"><%= i18n("filesmallerthan %s","42") %></label>
          <div class="fileinput fileinput-new input-group" data-provides="fileinput">
            <div class="form-control" data-trigger="fileinput"><i class="glyphicon glyphicon-file fileinput-exists"></i> <span class="fileinput-filename"></span></div>
            <span class="input-group-addon btn btn-default btn-file"><span class="fileinput-new"><%= i18n("selectfile") %></span><span class="fileinput-exists"><%= i18n("change") %></span><input id="input_avatar" type="file" name="avatar" data-parsley-filemaxmegabytes="42" data-parsley-trigger="change" data-parsley-filemimetypes="image/jpeg, image/png"></span>
            <a id="remove_iconfile_input" class="input-group-addon btn btn-default fileinput-exists" data-dismiss="fileinput"><%= i18n("remove") %></a>
          </div>
          <div>
            <img src="<%= user.avatarUrl %>" alt="Avatar" class="card-left card-circle card-margin-right" style="width:45px; margin-top: 36px">
          </div>
        </div>

        <script type="text/javascript">
          $('#upload_avatar').parsley().on('field:validated', function() {
            var ok = $('.parsley-error').length === 0;
          })
        </script>

        <div class="control-group">
          <label for="lan"><%= i18n("language") %> *:</label>
          <div>
            <select data-placeholder="<%= i18n("chooselanguage") %>" class="chzn-select-language" style="width:85px;" tabindex="2" required="" name="language">
              <option value=""></option>
              <option data-img-src="/images/flags/EN.png" value="en">EN</option>
              <option data-img-src="/images/flags/ES.png" value="es">ES</option>
              <option data-img-src="/images/flags/FR.png" value="fr">FR</option>
              <option data-img-src="/images/flags/PT.png" value="pt">PT</option>
            </select>
          </div>
          <script type="text/javascript">
            $('.chzn-select-language option[value="<%= user.language  %>"]').attr("selected",true);
            $('.chzn-select-language').chosen({"disable_search": true});
          </script>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="col-md-10">
        <div class="control-group">
          <label for="name"><%= i18n("title") %> * :</label>
          <input class="form-control" name="title" placeholder="<%= i18n("name") %>" value="<%= user.title %>"  type="text" required="">
        </div>

        <div class="control-group">
          <label for="password"><%= i18n("password") %> * :</label>
          <input id="passsword_field" type="password" class="form-control" placeholder="<%= i18n("password") %>" value="********" name="password" required>
        </div>

        <div class="control-group">
          <label for="passwordconf"><%= i18n("passwordconfirmation") %> * :</label>
          <input type="password" class="form-control" data-parsley-equalto="#passsword_field" placeholder="<%= i18n("passwordconfirmation") %>" value="********" name="confirmation" required>
        </div>

        <% if (session.authenticated && session.User.admin) { %>
        <div class="checkbox">
          <input type="hidden" name="admin" value="unchecked">
          <label><input type="checkbox" name="admin" checked="<%= user.admin %>"> Admin </label>
        </div>
        <% } %>

      </div>
      <div class="col-md-2"></div>
    </div>
  </div>
  <div class="form-signin">
    <input class="btn btn-lg btn-primary btn-block" value="<%= i18n('editaccount') %>" type="submit">
  </div>
  <input type="hidden" name="_csrf" value="<%= _csrf %>" />
</form>

<script type="text/javascript">
  addLoadEvent(set_parsley_lang('<%= (typeof(req.session) !== 'undefined' && req.session.languagePreference) ? req.session.languagePreference : sails.config.i18n.defaultLocale  %>'));
  $('#sign-up-form').parsley().on('field:validated', function() {
    var ok = $('.parsley-error').length === 0;
  })
</script>



<script type="text/javascript">
  function clean_file_input(){
    //llamar al evento limpiar
    //$("#remove_iconfile_input").trigger('click');
    //$("#parsley-id-9").remove();
    //$("#input_avatar").replaceWith('<input id="input_avatar" type="file" name="avatar" type="file" data-parsley-filemaxmegabytes="42" data-parsley-trigger="change" data-parsley-filemimetypes="image/jpeg, image/png">');
  }
</script>

































<label for="question"><%= i18n("filesmallerthan %s","42") %></label>
<form id="new_avatar" enctype="multipart/form-data" method="post">
  <div class="fileinput fileinput-new input-group" data-provides="fileinput">
    <div class="form-control" data-trigger="fileinput"><i class="glyphicon glyphicon-file fileinput-exists"></i> <span class="fileinput-filename"></span></div>
    <span id="input_icon" class="input-group-addon btn btn-default btn-file"><span class="fileinput-new">Select file</span><span class="fileinput-exists">Change</span><input type="file" name="avatar" data-parsley-filemaxmegabytes="42" data-parsley-trigger="change" data-parsley-filemimetypes="image/jpeg, image/png" required=""></span>
    <a id="remove_iconfile_input" href="#" class="input-group-addon btn btn-default fileinput-exists" data-dismiss="fileinput">Remove</a>
  </div>
  <input id="avatar_csrf" type="hidden" name="_csrf" value="<%= _csrf %>"/>
  <button type="button" class="btn btn-success" onclick='$("#new_avatar").submit()' >upload icon</button>
</form>

<script type="text/javascript">
  $('#new_avatar').parsley().on('field:validated', function() {
    var ok = $('.parsley-error').length === 0;
  })
</script>


<script type="text/javascript">
  $("#new_avatar").submit(function(e){
    e.preventDefault();
    var f = $(this);
    var formData = new FormData(document.getElementById("new_avatar"));

    $.ajax({
      url: '/user/edit_avatar/' + '<%= user.id %>',
      type: 'POST',
      cache: false,
      dataType: 'json',
      processData: false, // Don't process the files
      contentType: false, // Set content type to false as jQuery will tell the server its a query string request
      data: formData,
      beforeSend: function(xhr, settings){
        xhr.setRequestHeader('X-CSRF-Token', $("#avatar_csrf").val());
      },
      done:function() {
      },
      success: function(data){

        alert('success');

        if(typeof data.error === 'undefined')
        {
          console.log('SUCCESS: ' + data.success);
          bootstrap_alert['success']('A new icon has been uploaded!', 3000 );

          //limpiar el input
          $("#remove_iconfile_input").trigger('click');

          //AÃ±adir el nuevo icono al chosen select
          //

        }
        else
        {
          // Handle errors here
          console.log('ERRORS: ' + data.error);
        }
      }
    });
  });
</script>

