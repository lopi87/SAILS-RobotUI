<%- partial('../_alert.ejs', {flash: flash}) %>

<div class="jumbox margintop20">
  <h2 class="form-sigin-heading"><%= i18n('robots') %></h2>
  <div class="table-responsive">
    <table class="table table-striped ">
      <thead>
      <tr>
        <th>Online</th>
        <th>Name</th>
        <th>Description</th>
        <th>IP:PORT</th>
        <th>Owner</th>
        <th>Public drive</th>
        <th>Public view</th>
        <th colspan="4">Actions</th>
      </tr>
      </thead>

      <tbody id="robot_list">
      <% _.each(data.robots, function(robot){ %>
        <tr id="line_<%= robot.id %>" data-model="robot">

          <% if(robot.busy){ %>
            <td> <img id="img_state_<%=robot.id%>" src="/images/online.png" height="30" width="30"></td>
          <% } else { %>
            <td> <img id="img_state_<%=robot.id%>" src="/images/offline.png" height="30" width="30"></td>
          <% } %>

          <td>
            <img src="<%= sails.getBaseUrl() + robot.avatarUrl %>" alt="Avatar" class="card-left card-circle card-margin-right" style="width:30px">
            <a href="/robot/show/<%= robot.id %>"><%= robot.name %></a>
          </td>
          <td><%= robot.description %></td>

          <td><%= robot.ipaddress + ':' + robot.port %> </td>

          <td>
            <a href="/user/show/<%= robot.owner.id %>"><%= robot.owner.name %></a>
            <img src="<%= sails.getBaseUrl() + robot.owner.avatarUrl %>" alt="Avatar" class="card-left card-circle card-margin-right" style="width:32px">
          </td>

          <% if(robot.public_view){ %>
          <td>
            <span class="label label-pill label-success"> <%= i18n('public')%> </span>
          </td>
          <% } else { %>
          <td> <span class="label label-pill label-danger"> <%= i18n('private')%> </span></td>
          <% } %>

          <% if(robot.public_drive){ %>
          <td>
            <span class="label label-pill label-success"> <%= i18n('public')%> </span>
          </td>
          <% } else { %>
          <td> <span class="label label-pill label-danger"> <%= i18n('private')%> </span></td>
          <% } %>

          <td>
            <a href="/interface/view/<%= robot.iface.id %>" class="btn btn-sm btn-primary"><%= i18n('interface') %></a>
          </td>
          <td>
            <a href="/robot/edit/<%= robot.id %>" class="btn btn-sm btn-warning"><%= i18n('edit') %></a>
          </td>
          <td>
            <form action="/robot/destroy/<%=robot.id%>" method="post">
              <input type="hidden" name="_method" value="delete"/>
              <input type="submit"  class="btn btn-sm btn-danger" value="Delete"/>
              <input type="hidden" name="_csrf" value="<%= _csrf %>"/>
            </form>
          </td>
       </tr>
      <% })%>
      </tbody>
    </table>
  </div>

  <%- partial ('../_paginate.ejs', { paginate: data.meta.paginate } )%>

</div>

<div id="robot_list"></div>

<script type="text/javascript">

  function subscribeAndListen() {
    io.socket.get('/robot/robot_subscribe');

    io.socket.on('robot', function (obj) {
      if (obj.verb == 'created') {
        var user = obj.data;
        $.ajax({
          url: '/robot/render',
          type: 'GET',
          data: {id: user.id},
          success: function(data){
            $("#robot_list").append(data);
           toastr.info('A new robot has been created!', 'Robot' )
          }
        });
      }

      if (obj.verb == 'updated') {
        var data = obj.data;
        change_img_state(data.id, data.busy);

        if(data.busy){
         toastr.info('Robot connected!', 'Robot' );
        }else{
         toastr.info('Robot disconnected!', 'Robot' );
        }
        console.log('Robot has been updated to online:' + data.busy);
      }

      if (obj.verb == 'destroyed') {
        $("#line_" + obj.id).remove();
       toastr.info('A robot has been deleted!', 'Robot' );
      }

    });

  }

</script>


