<%- partial('../_alert.ejs', {flash: flash}) %>

<div class="text-center marginbottom20">
  <h1>Control panel <small> <%= robot.name %> </small></h1>
</div>

<div id="board" class="panel panel-success margintop20">
  <div class="panel-heading">
    <img style="max-width:150px;" src="/images/logo/logotipo.png">
    <a href="#" onclick="openWin(200,200,'board')"><i class="fa fa-external-link fa-2x floatright" style="height: 20px"></i></a>
  </div>

  <div class="paddingtop20 paddingleft20 paddingright20">

    <div class="row marginbottom10 marginleft20">
      <img id="img_state_<%= robot.id %>" height="30" width="30" src="/images/offline.png" class="marginright20">
      <button  id="conectar" type="button" class="marginlef10 btn btn-sm btn-success">CONECTAR</button></td>
      <button  id="desconectar" type="button" class="btn btn-sm btn-danger">DESCONECTAR</button></td>
    </div>

    <div>
      <div class="col-md-1">
        <div id="user_list">
          <% if(typeof viewer_users !== 'undefined' && viewer_users ){%>
          <% _.each(viewer_users, function(v_user){ %>
          <img src="<%= v_user.avatarUrl %>" alt="Avatar" class="card-left card-circle card-margin-right" style="width:75px">
          <%= v_user.name %>
          <% })%>
          <%}%>
        </div>
      </div>

      <div id="box_panel" class="col-md-11">
        <div id="panel" class="panel_resizable work">

          <!-- Insert video -->
          <% if (videos){%>
          <% _.each(videos, function(video){ %>
          <img id="play_<%= video.id %>" class="img-responsive play_<%= video.id %> position_<%= video.id %>" src="/images/video/video.png" width="400" height="300">
          <%- partial ('../video/style_video.ejs', {video: video})%>
          <% })%>
          <%}%>

          <!-- Insert actions -->
          <% _.each(actions, function(action){ %>
          <% if (action.icon){ %>
          <button id="button_custom_<%= action.id %>" class="btn position_<%= action.id %> btn-custom_<%= action.id %>" value="<%= action.code %>">
            <img src="/uploads/icons/<%= action.icon %>.png" />
            <% if (action.name != ''){%>
            <%= action.name %>
            <% }%>
          </button>
          <% } else { %>
          <button  id="button_<%= action.id %>" value="<%= action.code %>" class="btn position_<%= action.id %> btn-custom_<%= action.id %>"><%= action.name %></button>
          <% } %>
            <%- partial ('../action/style_action.ejs', {action: action})%>
          <% })%>


          <!-- Insert events -->
          <% _.each(events, function(event){ %>
          <div id="event_<%= event.id %>" class="event_<%= event.id %> position_<%= event.id %>" style="max-width: 100px">
            <h5><%= event.name %> <span class="label label-pill label-danger">-</span></h5>
          </div>
          <%- partial ('../event/style_event.ejs', {event: event})%>
          <% })%>


        </div>
      </div>
    </div>
    <script type="text/javascript">
      $( "#panel").width(<%= interface.panel_sizex %>);
      $( "#panel").height(<%= interface.panel_sizey %>);
    </script>
    <div class="row">
      <div class="col-md-12 col-sm-12">
        <div class="marginright20 margintop10 marginbottom10 floatright">
          <!--
          <a id="save_dash" class="btn btn-sm btn-success" > Save dashboard! </a>
          <a id="edit_dash" class="btn btn-sm btn-warning" > Edit dashboard! </a>
          <a id="reset_dash" class="btn btn-sm btn-danger" > Reset dashboard! </a>
        -->
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="pull-right margintop20 marginbottom20">
    <a href="/robot/index" class="btn btn-sm btn-warning">Back</a>
  </div>

<% partial ('commands.ejs', {robot: robot})%>


<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">



    // https://evothings.com/controlling-a-toy-car-with-evothings-and-raspberry-pi/

    //ROBOT
    //conexion con el robot
    var address_robot = "localhost" + ":" + "8085";
    var robot_id = '<%= robot.id %>';
    //INTERESANTE RECONCETAR AUTOMATICAMENTE-...... solucion ya que tarda en volver a conectar
    //http://stackoverflow.com/questions/4432271/node-js-and-socket-io-how-to-reconnect-as-soon-as-disconnect-happens
    $("#conectar").click(function() {
      try {
        // Connect to the server running on the Robot(raspberry pi).
        var socket = io.connect(address_robot, {
          'reconnection': true,
          'reconnectionDelay': 500,
          'reconnectionAttempts': 10
        });
        socket.on('connect', function () {
          console.log('robot connected!');
          //Sincronizar con el resto de clientes que un robot se ha conectado:
          io.socket.get('/robot/changetobusy/', {robot: robot_id, state: 'on'});
          bootstrap_alert['success']('Conectado con exito! ' + address_robot, 5000);
          change_img_state(robot_id, true);
        });

      } catch (error) {
        bootstrap_alert['danger']('Failed to connect to the Robot! (Raspberry Pi!)' + address_robot + error, 5000)
        io.socket.get('/robot/changetobusy/', {robot: robot_id, state: 'off'});
        change_img_state(robot_id, false);
      }


      //Presionar boton desconectar
      $("#desconectar").click(function () {
        try {
          socket.disconnect();
        } catch (error) {
          bootstrap_alert['danger']('Failed to disconnect to the Robot!' + address_robot + error, 5000)
          io.socket.get('/robot/changestate/', {robot: robot_id, state: 'off'});
          change_img_state(robot_id, false);
        }
      });

      //captura evento desconectar cuando el robot es apagado o pierde la se√±al
      socket.on('disconnect', function () {
        bootstrap_alert['success']('Robot disconnect!' + address_robot, 5000)
        //Sincronizar con el resto de clientes:
        io.socket.get('/robot/changestate/', {robot: robot_id, state: 'off'});
        change_img_state(robot_id, false);
      });


      //Mandar evento "mandar comando" al servidor para sincronizar con otros navegadores
      /*
      var $messageForm = $('#sendMessage');
      $messageForm.submit(function (e) {
        var $message = $('#message');
        e.preventDefault();
        if($message.val() != '' ) io.socket.get('/interface/commandline/',{interface: '<%= interface.id %>' ,user_id: '<%= session.User.id%>'   ,command: $message.val()});
        command_send(socket, 'direction', $message.val())
        $message.val('');
      });
      */



      //Presionar boton accion!
      var interface_buttons = $('[id^=button_]');
      interface_buttons.click(function (e) {
        e.preventDefault();
        var button_pressed_id = this.id.replace('button_custom_','');
        var code = document.getElementById(this.id).value

        //io.socket.get('/interface/commandline/',{interface: '<%= interface.id %>' ,user_id: '<%= session.User.id%>'   ,button: button_pressed_id})

        io.socket.get('/interface/emit_action/',{robot: '<%=robot.id %>', id: button_pressed_id, msg: code })


        if (code != ''){
          //Mandar instruccion al robot
          socket.emit('direction', code);
          console.log('Emitiendo comando: ' + code );
        }
      });




      <!-- Insert events -->
      <% _.each(events, function(event){ %>
      socket.on("<%= event.event_name %>", function messageReceived(message) {
        io.socket.get('/interface/emit_event/',{robot: '<%=robot.id %>', id: '<%= event.id %>', msg: message.msg  })
        $('#event_<%= event.id%>').html('<h5><%= event.name %> <span class="label label-pill label-danger">' + message.msg + '</span></h5>');
      });
      <% })%>


      //Implementar funcion de escucha: PROVISIONAL RECIBE UN MENSAJE CONCRETO BORRAR!!!!!!!!!
      socket.on('robotmsg', function messageReceived(message) {
        alert(message.msg);
        io.socket.get('/interface/emit_event/',{robot: '<%=robot.id %>',id: 'id', msg: message.msg })
      });

    });




</script>
