<!-- PERSONALIZAR VENTANA -->
<div id="board" class="panel panel-success margintop20 paddingbottom20">
  <div class="panel-heading"> Control </div>

  <div class="paddingtop20 paddingleft20 paddingright20">
    <div class="row">
      <div class="col-md-2">
        <div class="bottom_col">
          <div class="list-group">
            <a class="list-group-item"><i class="fa fa-plus fa-2 marginlef10" aria-hidden="true"></i>&nbsp;</a>
            <a class="list-group-item"><i class="fa fa-remove fa-2 marginlef10" aria-hidden="true"></i>&nbsp;</a>
            <a class="list-group-item"><i class="fa fa-edit fa-2 marginlef10" aria-hidden="true"></i>&nbsp;</a>
            <a class="list-group-item"><i class="fa fa-plug fa-2 marginlef10" aria-hidden="true"></i>&nbsp;</a>
            <a class="list-group-item"><i class="fa fa-cog fa-2 marginlef10" aria-hidden="true"></i>&nbsp;</a>
          </div>
        </div>
      </div>

      <div id="box_panel" class="col-md-10">
        <div id="panel" class="panel_resizable edit">

          <% if(video){%>
          <img id="play_<%= video.id %>" class="img-responsive play_<%= video.id %> position_<%= video.id %>" src="/images/video/video.png" width="400" height="300">
          <%}%>

          <% _.each(actions, function(action){ %>
          <% if (action.icon){ %>
          <button id="button_custom_<%= action.id %>" class="btn btn-custom_<%= action.id %> position_<%= action.id %>" value="<%= action.code %>">
            <img src="<%= action.icon.iconUrl %>" height="32px" width="32px"/>
            <% if (action.name != ''){%>
            <%= action.name %>
            <% }%>
          </button>
          <% } else { %>
          <button  id="button_custom_<%= action.id %>" value="<%= action.code %>" class="btn btn-custom_<%= action.id %> position_<%= action.id %>" ><%= action.name %></button>
          <% } %>
          <%- partial ('../action/style_action.ejs', {action: action})%>
          <% })%>

          <% _.each(events, function(event){ %>
          <div id="event_<%= event.id %>" class="event_<%= event.id %> position_<%= event.id %>" style="max-width: 100px">
            <h5><%= event.name %> <span class="label label-pill label-danger">-</span></h5>
          </div>
          <%- partial ('../event/style_event.ejs', {event: event})%>
          <% })%>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="margintop20 marginbottom20">
  <a href="/robot/index" class="btn btn-sm btn-warning bottom-right"> My Robots</a>
  <a href="/interface/show/<%= interface.id %>" class="btn btn-sm btn-primary bottom-right"><i class="fa fa-gamepad" aria-hidden="true"></i> Take control</a>
</div>


<input id="icon_csrf" type="hidden" name="_csrf" value="<%= _csrf %>"/>


<script type="text/javascript">

  function get_max_top_left_panel() {

    var cord1 = max_top_left('[id^=button_custom_]');
    var cord2 = max_top_left('[id^=event_]');
    var cord3 = [];

    cord3[0] = (cord1[0] > cord2[0] ? cord1[0] : cord2[0]);
    cord3[1] = (cord1[1] > cord2[1] ? cord1[1] : cord2[1]);

    //console.log('Limit: ' + cord3[0] + ' - ' + cord3[1]);
    return [cord3[0] ,cord3[1] ];
  }


  function max_top_left(id){
    var top = 0, left = 0, inHeight = 0, inWidth = 0;
    $(id).each(function(){
      if ($(this).position().top >= top){
        inHeight = $(this).outerHeight() + 5;
        top = $(this).position().top;
        //console.log('New top limit: ' + $(this).position().top);
      }

      if ($(this).position().left >= left){
        inWidth = $(this).outerWidth() + 5;
        left = $(this).position().left;
        //console.log('New left limit: ' + $(this).position().left);
      }
    });

    console.log('Dims: ' + inWidth + ' - ' + inHeight);
    console.log('Limit: ' + left + ' - ' + top);

    left = left + inWidth;
    top = top + inHeight;

    return [left ,top ];
  }

  //Enable elements draggables
  $('[id^=button_custom_]').draggable({cancel: false, containment: '#panel', scroll: false,

    stop: function(event, ui) {
      var pos_x = ui.position.left;
      var pos_y = ui.position.top;
      var id = this.id.replace('button_custom_','');

      console.log('x: ' + pos_x + ' - y: ' + pos_y );
      //console.log('id: ' + id);

      $.ajax({
        type: "POST",
        url: "/action/update_position/",
        data: { x: pos_x, y: pos_y, id: id},
        beforeSend: function(xhr, settings){
          xhr.setRequestHeader('X-CSRF-Token', $("#icon_csrf").val());
        },

        success: function(data){
          console.log('bottom position updated');
        },

        error: function(xhr, status, text) {
          bootstrap_alert['danger'](xhr.responseText, 5000 );
        }

      });
    }
  });


  //Enable elements draggables
  $('[id^=play_]').draggable({cancel: false, containment: '#panel', scroll: false,

    stop: function(event, ui) {
      var pos_x = ui.position.left;
      var pos_y = ui.position.top;
      var id = this.id.replace('play_','');

      console.log('x: ' + pos_x + ' - y: ' + pos_y );
      //console.log('id: ' + id);

      //Do the ajax call to the server
      $.ajax({
        type: "POST",
        url: "/video/update_position/",
        data: { x: pos_x, y: pos_y, id: id},
        beforeSend: function(xhr, settings){
          xhr.setRequestHeader('X-CSRF-Token', $("#icon_csrf").val());
        },

        success: function(data){
          console.log('video position updated');
        },

        error: function(xhr, status, text) {
          bootstrap_alert['danger'](xhr.responseText, 5000 );
        }

      });
    }
  });

  //Enable elements draggables
  $('[id^=event_]').draggable({cancel: false, containment: '#panel', scroll: false,

    stop: function(event, ui) {
      var pos_x = ui.position.left;
      var pos_y = ui.position.top;
      var id = this.id.replace('event_','');

      console.log('x: ' + pos_x + ' - y: ' + pos_y );
      //console.log('id: ' + id);

      //Do the ajax call to the server
      $.ajax({
        type: "POST",
        url: "/event/update_position/",
        data: { x: pos_x, y: pos_y, id: id},
        beforeSend: function(xhr, settings){
          xhr.setRequestHeader('X-CSRF-Token', $("#icon_csrf").val());
        },

        success: function(data){
          console.log('event position updated');
        },

        error: function(xhr, status, text) {
          bootstrap_alert['danger'](xhr.responseText, 5000 );
        }

      });
    }
  });

  // http://jsfiddle.net/dzSRR/32/  ejemplo drag con limites
  $("#panel").resizable({
    maxWidth: $("#box_panel").width() - 10,

    create: function(){
      $(this).width(<%= interface.panel_sizex %>);
      $(this).height(<%= interface.panel_sizey %>);
    },

    resize: function(){
      pos = get_max_top_left_panel();

      console.log(pos[0] + '-' + pos[1]);

      $(this).css("min-width", pos[0]);
      $(this).css("min-height", pos[1]);
    },

    stop: function(event, ui) {
      var width = ui.size.width;
      var height = ui.size.height;
      var id = "<%= interface.id %>";

      //Tam en px eliminar 'px'
      var min_w = $("#panel").css("minWidth").replace(/[^-\d\.]/g, '');
      var min_h = $("#panel").css("minHeight").replace(/[^-\d\.]/g, '');

      //console.log('new board size: ' + width + ' - ' + height );
      console.log('valores minimos permitidos: ' + min_w + '-'  + min_h);

      //Nunca menor que el tama√±o minimo
      if(width < min_w){
        width = min_w;
      }
      if(height < min_h){
        height = min_h;
      }

      //Do the ajax call to the server
      $.ajax({
        type: "POST",
        url: "/interface/update_board_size/",
        data: { width: width, height: height, id: id},
        beforeSend: function(xhr, settings){
          xhr.setRequestHeader('X-CSRF-Token', $("#icon_csrf").val());
        },

        success: function(data){
          console.log('board size updated');
        },

        error: function(xhr, status, text) {
          bootstrap_alert['danger'](xhr.responseText, 5000 );
        }
      });
    }

  });

</script>
<!-- FIN PERSONALIZAR VENTANA -->
